#!/bin/bash -eu

# re-exec as root
set -eu
if [ "$(id -u)" != 0 ]
then
  exec sudo $(readlink -f $0)
fi

# reset the iptables firewall
for table in filter nat mangle raw security
do
  iptables -F -t "$table"
  iptables -X -t "$table"

  ip6tables -F -t "$table"
  ip6tables -X -t "$table"
done

iptables -t filter -A INPUT -i lo -j ACCEPT

iptables -t filter -A INPUT -i natbr0 -j ACCEPT
iptables -t filter -A INPUT -i zerobr0 -j ACCEPT
iptables -t filter -A INPUT -i docker0 -j ACCEPT

iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

iptables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport 443 -j ACCEPT

iptables -t filter -P INPUT DROP

iptables -t filter -I FORWARD -i natbr0 -j ACCEPT
iptables -t filter -I FORWARD -i zerobr0 -j ACCEPT
iptables -t filter -I FORWARD -i docker0 -j ACCEPT

iptables -t filter -P FORWARD DROP

iptables -t nat -I POSTROUTING -o + -j MASQUERADE

ip6tables -t filter -P INPUT DROP
ip6tables -t filter -P FORWARD DROP
ip6tables -t filter -A INPUT -i lo -j ACCEPT
ip6tables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
ip6tables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT
ip6tables -t filter -A INPUT -p tcp --dport 2222 -j ACCEPT
