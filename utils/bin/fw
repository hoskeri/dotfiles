#!/bin/bash -eu

# re-exec as root
set -eu
if [ "$(id -u)" != 0 ]
then
  exec sudo $(readlink -f $0)
fi

# reset the iptables firewall
for table in filter nat mangle raw security
do
  iptables -F -t "$table"
  iptables -X -t "$table"
done

iptables -t filter -A INPUT -i lo -j ACCEPT
iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -t filter -P INPUT DROP

iptables -t nat -I POSTROUTING -o + -j MASQUERADE
iptables -t filter -I FORWARD -i natbr0 -j ACCEPT
