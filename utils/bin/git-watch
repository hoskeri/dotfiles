#!/bin/bash
set -eu
export SHELLOPTS
filelist=$(mktemp /tmp/git-watch-filelistXXXXXX)
ignfile=$(mktemp /tmp/git-watch-ignXXXXXXX)
bgpid=$$

if [ -e .watchbgscript ]
then
  ./.watchbgscript &
  bgpid=$(jobs -p)
fi

trap "rm -f $filelist $ignfile; kill $bgpid" EXIT
max_files=128

cd $(git root)
target="$@"

test -f .watchignore && cat .watchignore >> $ignfile
test -e .watchscript && target=./.watchscript

test -z "$target" && echo "usage: git-watch command" && exit 1

while true
do
  git ls-files --full-name |grep -v -s -f $ignfile > $filelist
  if [ "$(wc -l $filelist|cut -d' ' -f1)" -gt $max_files ]
  then
    echo "error: git-watch: too many files (max $max_files)" >&2
    exit 1
  fi
  entr -d "$target" < $filelist
done
