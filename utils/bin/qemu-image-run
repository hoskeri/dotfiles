#!/bin/sh -eu

workdir="$HOME/.qemu-image-builder/vms"
vm="$workdir/${1:-}"
diskname="$vm/snapshot.qcow2"
base="$vm/base.qcow2"
macaddr_filename="$vm/macaddr"
uuid_filename="$vm/uuid"

test -z "${1:-}" && ( echo "no vm given!" && exit 1 )
test -d "$vm" || ( echo "$vm not found!" && exit 1 )
test -f "$macaddr_filename" || ( echo "$macaddr not found!" && exit 1 )
test -f "$uuid_filename" || ( echo "$uuid not found!" && exit 1 )
test -f "$diskname" || qemu-img create -q -f qcow2 -b "$base" "$diskname"

macaddr=$(cat "$macaddr_filename")
uuid=$(cat "$uuid_filename")

qemu-system-x86_64 \
  -vga qxl \
  -name "$vm" \
  -enable-kvm -cpu host \
  -uuid "$uuid" \
  -net nic,model=virtio,macaddr="$macaddr" \
  -net bridge,br=natbr0 \
  -m 512 \
  -kernel /boot/vmlinuz-4.9.0-3-amd64 \
  -initrd /boot/initrd.img-4.9.0-3-amd64 \
  -append 'root=LABEL=ROOTFS rw quiet' \
  -drive file="$diskname",format=qcow2,if=virtio,cache=directsync \
  -nographic \
  -spice unix,addr="$vm/spice.sock",disable-ticketing
