#!/bin/sh -eu

[ "$(id -u)" != "0" ] && ( echo "please run as root" && exit 1 )

DESTDIR=/home/git
GITEA_USER=git
GITEA_GROUP=git
tmpfile=$(mktemp $DESTDIR/gitea-tmpXXXXX)

trap "rm -f $tmpfile" EXIT

test -f $DESTDIR/gitea && chattr -i $DESTDIR/gitea
curl -f -o $tmpfile https://dl.gitea.io/gitea/master/gitea-master-linux-amd64
chmod +x $tmpfile

mv $tmpfile $DESTDIR/gitea
chown ${GITEA_USER}:${GITEA_GROUP} $DESTDIR/gitea
chattr +i $DESTDIR/gitea

cat <<END > $DESTDIR/git.service
[Unit]
Description=git service.
After=network.target
Requires=network.target local-fs.target

[Service]
ExecStart=/home/git/gitea web
WorkingDirectory=~
User=git
Group=git
LimitNOFILE=1048576
LimitNPROC=1048576
LimitCORE=0
ProtectSystem=yes
MemoryMax=128M
TasksMax=32
MemorySwapMax=128M
PrivateDevices=true
Restart=always

[Install]
WantedBy=multi-user.target
END
systemctl enable /home/git/git.service
systemctl restart git
