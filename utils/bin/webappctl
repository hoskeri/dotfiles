#!/bin/bash
set -eu
export SHELLOPTS

# create a user account
APPNAME=$(echo $1|tr -C -d  '[a-z0-9]')

test -n "$APPNAME"

APPGROUP=www-data
HOMEDIR=/home/webapps/$APPNAME
USERNAME=webapp-$APPNAME

ADDUSER_FLAGS="
  --gecos="Webapp,$APPNAME"
  --no-create-home
  --disabled-password
  --firstuid 35000
  --lastuid 40000
  --ingroup $APPGROUP
  --home $HOMEDIR
  --shell /usr/bin/git-shell
  webapp-$APPNAME"

getent passwd webapp-appt > /dev/null || sudo adduser $ADDUSER_FLAGS
sudo install -d -m 750 -o $USERNAME -g $APPGROUP $HOMEDIR
sudo su - -s /bin/sh -c 'test -d repo.git || git init -q --bare repo.git' $USERNAME
sudo su - -s /bin/bash $USERNAME
